# I18n Workflow
![i18n scheme](https://user-images.githubusercontent.com/700119/140646548-fcf6433d-1fa0-4323-98e2-9cc49550e5ee.png)

## I18n Context
I18n will generate a `I18nContextInterface` object at **every request** which is accessible via the resolver
service `I18nContextResolverInterface`. Which means, that you're able to fetch the `I18nContextInterface`
via `[DI] $contextResolver->getContext($request)` wherever a valid frontend-request is available!

### Locale Definition
The I18n Context contains a `LocaleDefinitionInterface` object, which contains all locale information about the requested locale.

### Route Item
The I18n Context contains a `RouteItemInterface` object, which terminates the right route process.

- If the i18n context gets resolved via request, the route item will be generated depending on the request attributes (static
  route, symfony route, document)
- If the i18n context gets resolved by a headless context generation or a simple `url(route_name, {})`, the route item will be
  generated depending on the route parameters (static route, symfony route, document)

### Zone
The I18n Context contains a `ZoneInterface` object, which holds all active zone information (allowed/active locales, bounded
domains)

#### Zone Site
Each `ZoneInterface` object is able to contain one or more `ZoneSiteInterface` objects. Each Site contains dedicated information
and also provides an `SiteRequestContext` object. The site request context holds some important information (like `host`, `port`)
which are required when it comes to absolute URL generation!

***

## Router
I18n will decorate the `router` service. This is required to provide a simple way generating URLs in different contexts (twig, API, command line).
The I18nRouter automatically takes care about the correct router context. If you need absolute URLs for example, just set `UrlGeneratorInterface::ABSOLUTE_URL` and you're good to go.  

## PIMCORE Link Generator
Every Link Generator needs to implement the `I18nLinkGeneratorInterface`! This is required to allow i18n to generate translatable static routes by itself!

```php
<?php

namespace App\Service;

use I18nBundle\LinkGenerator\I18nLinkGeneratorInterface;
use I18nBundle\Model\RouteItem\LinkGeneratorRouteItemInterface;
use Pimcore\Model\DataObject\ClassDefinition\LinkGeneratorInterface;
use Pimcore\Model\DataObject\Concrete;

class ObjectLinkGenerator implements LinkGeneratorInterface, I18nLinkGeneratorInterface
{
    public function getStaticRouteName(Concrete $object): string
    {
        return 'test_route';
    }

    public function generateRouteItem(Concrete $object, LinkGeneratorRouteItemInterface $linkGeneratorRouteItem): LinkGeneratorRouteItemInterface
    {
        $linkGeneratorRouteItem->getRouteParametersBag()->set('object_id', $object->getId());

        return $linkGeneratorRouteItem;
    }

    public function generate(Concrete $object, array $params = []): string
    {
        // do not use this method if you're using i18n.
        // use generateForI18n() instead!

        return '';
    }
}
```

## Static Routes
PIMCORE static routes are in `yaml` format now and this allows us to determinate the static route patterns via container parameters:

```yaml
i18n:
    translations:
        - key: 'myStaticRouteKey'
          values:
              de: 'meine-statische-route'
              en: 'my-static-route'
              
pimcore:
    staticroutes:
        definitions:
            60f02a5d-eb8f-4fb2-859a-0a3c77b472f9:
                name: my_static_route
                pattern: '/([a-zA-Z0-9-_]*)\/(?:%i18n.route.translations.myStaticRouteKey%)\/(.*?)$/' ## returns (meine-statische-route|my-static-route)
                reverse: '/{%%_locale}/@myStaticRouteKey/%%object_id'
                controller: App\Controller\DefaultController::staticRouteAction
                variables: '_locale,object_id'
                defaults: null
                siteId: null
                methods: null
                priority: 1
                creationDate: 1634472684
                modificationDate: 1634472684
```

## Symfony Routes
I18n also supports (localized) symfony routes. You need to pass the `_i18n` default flag (can be an array or just a boolean flag).

### Localized Symfony Routes
```yaml
my_symfony_route:
    path:
        de: /de/i18n/symfony-default-rut
        fr: /fr/i18n/symfony-default-ruteee
        de_CH: /de-ch/i18n/symfony-default-route-guetzli
        en: /en/i18n/symfony-default-route
    defaults:
        _i18n: true
        _controller: App\Controller\DefaultController::symfonyRouteAction
```

### I18n Localized Symfony Routes
Every I18n translation key is available as a regex parameter (`i18n.route.translations.TRANSLATION_KEY_NAME`).
This allows you to define translations at a global scope and is much cleaner to configure

```yaml
i18n:
    translations:
        - key: 'mySymfonyRouteKey'
          values:
              de: 'meine-symfony-route'
              en: 'my-symfony-route'
              
my_symfony_route:
    path: /{_locale}/i18n/{matching_route_key}
    defaults:
        _i18n:
            translation_keys:
                matching_route_key: mySymfonyRouteKey
        _controller: App\Controller\DefaultController::symfonyRouteAction
    requirements:
        matching_route_key: '(%i18n.route.translations.mySymfonyRouteKey%)' ## returns (meine-symfony-route|my-symfony-route)
```

## Command Line
Generating absolute URLs in CL is easy! Let's create a static route (which will dispatch your LinkGenerator):

```php
$routeParameters = [
    '_i18n' => [
        'type'   => RouteItemInterface::STATIC_ROUTE,
        'entity' => $object,
        'routeParameters' => [
            '_locale'   => 'en'
        ],
        'context'         => [
            ## if you're having sites, you need to define zones
            ## if you're having zones, you MUST pass the site context parameter
            ## that's the rule!
            'site' => Site::getByDomain('test-domain1.test')
        ]
    ]
];

echo $this->router->generate('', $routeParameters, UrlGeneratorInterface::ABSOLUTE_URL);
```

## Twig Helper
Generating a complete headless context object via twig:

```twig
{# SECTION A: simple i18n route generation #}

{# simple url() #}
{{ url('my_symfony_route', {_i18n: { type: 'symfony', routeParameters: {_locale: 'de'}, context: { site: pimcore_site_by_domain('test-domain1.test') }}}) }}
{# simple path() without configured zones #}
{{ path('my_symfony_route', {_i18n: { type: 'symfony', routeParameters: {_locale: 'de'} }}) }}


{# SECTION B: complete i18n context generation #}

{% set object_context = i18n_create_context_by_symfony_route('my_symfony_route', {_locale: 'en'}) %}
{{ dump(object_context) }}
{{ dump(object_context.linkedLanguages) }}
    
{#
    if you're having sites, you need to define zones
    if you're having zones, you MUST pass the site context parameter
    that's the rule!
#}
{% set route_site = pimcore_site_by_domain('test-domain1.test') %}
{% set zone_aware_object_context = i18n_create_context_by_symfony_route('my_symfony_route', {_locale: 'en'}, route_site) %}
{{ dump(zone_aware_object_context) }}
{{ dump(zone_aware_object_context.linkedLanguages) }}
```

## PHP Helper
Generating a complete headless context object via php api. Let's dump some examples:

```php

// SECTION A: complete i18n context generation

// $i18nContextManager = [DI] I18nBundle\Manager\I18nContextManager
$routeItemParameters = [
    'type'            => RouteItemInterface::SYMFONY_ROUTE,
    'routeParameters' => [
        '_locale' => 'de'
        // ... and all your special route params which i18n are not aware off
    ],
    'routeName'       => 'my_static_route',
    'context'         => [
        'site' => Site::getByDomain('test-domain1.test')
    ]
];

// if you want to use the `$i18nContext.getLinkedLanguages()`
// you need to pass the second boolean argument as true to boot the path generator adapter
// this is disabled by default because it is not required when generating default routes
$i18nContext = $i18nContextManager->buildContextByParameters($routeItemParameters, true);

// SECTION B: simple i18n route generation

// $router = [DI] Symfony\Component\Routing\RouterInterface
dump('static route (without entity) and site:' . $router->generate('my_static_route', [
    '_i18n' => [
        'type'            => RouteItemInterface::STATIC_ROUTE,
        'routeName' => 'my_static_route'
        'routeParameters' => [
            '_locale'   => 'de'
            // ... and all your special route params which i18n are not aware off
        ],
        'context'         => [
            ## if you're having sites, you need to define zones
            ## if you're having zones, you MUST pass the site context parameter
            ## that's the rule!
            'site' => Site::getByDomain('test-domain1.test')
        ]
    ]
], UrlGeneratorInterface::ABSOLUTE_URL));

dump('static route (with entity): ' . $router->generate('', [
    '_i18n' => [
        'type'            => RouteItemInterface::STATIC_ROUTE,
        'entity'          => $object,
        'routeParameters' => [
            '_locale' => 'de'
            // ... and all your special route params which i18n are not aware off
        ]
    ]
], UrlGeneratorInterface::ABSOLUTE_URL));

dump('symfony route: ' . $router->generate('my_symfony_route', [
    '_i18n' => [
        'type'            => RouteItemInterface::SYMFONY_ROUTE,
        'routeParameters' => [
            '_locale' => 'de'
            // ... and all your special route params which i18n are not aware off
        ]
    ]
], UrlGeneratorInterface::ABSOLUTE_URL));

dump('non i18n symfony route: ' . $router->generate('my_non_i18n_aware_symfony_route', ['_locale' => 'en'], UrlGeneratorInterface::ABSOLUTE_URL));
```

## Code Examples
Please check out the [code examples](./60_CodeExamples.md) doc section to learn more about accessing zone information.